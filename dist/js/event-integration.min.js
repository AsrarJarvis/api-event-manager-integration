var EventManagerIntegration={};(EventManagerIntegration=EventManagerIntegration||{}).Event=EventManagerIntegration.Event||{},EventManagerIntegration.Event.Module=function(o){function c(){o(function(){this.initEventPagination()}.bind(this))}return c.prototype.initEventPagination=function(){o(".modularity-mod-event").each(function(e,t){var n=o(this).find("[data-module-id]").attr("data-module-id"),a=o(this).find(".module-pagination").attr("data-pages"),i=o(this).find(".module-pagination").attr("data-show-arrows"),r=o(this);o(this).find(".module-pagination").pagination({pages:a,displayedPages:4,edges:0,cssStyle:"",ellipsePageSet:!1,prevText:i?"&laquo;":"",nextText:i?"&raquo;":"",currentPage:1,selectOnClick:!1,onPageClick:function(e,t){c.prototype.loadEvents(e,n,r),o(r).find(".module-pagination").pagination("redraw"),o(r).find(".pagination a:not(.current)").each(function(){o(this).parent().addClass("disabled temporary")})}})})},c.prototype.loadEvents=function(e,t,n){var a=o(n).find(".event-module-content").height(),i=o(window).scrollTop(),r=o(n).offset().top;o.ajax({url:eventintegration.ajaxurl,type:"post",data:{action:"ajax_pagination",page:e,id:t},beforeSend:function(){o(n).find(".event-module-list").remove(),o(n).find(".event-module-content").append('<div class="event-loader"><div class="loading-wrapper"><div class="loading"><div></div><div></div><div></div><div></div></div></div></div>'),o(n).find(".event-loader").height(a),r<i&&o("html, body").animate({scrollTop:r},100)},success:function(e){o(n).find(".event-module-content").append(e).hide().fadeIn(80).height("auto")},error:function(){o(n).find(".event-module-content").append('<ul class="event-module-list"><li><p>'+eventIntegrationFront.event_pagination_error+"</p></li></ul>").hide().fadeIn(80).height("auto")},complete:function(){o(n).find(".event-loader").remove(),o(n).find(".pagination .temporary").each(function(){o(this).removeClass("disabled temporary")})}})},new c}(jQuery),(EventManagerIntegration=EventManagerIntegration||{}).Event=EventManagerIntegration.Event||{},EventManagerIntegration.Event.Form=function(d){function u(){d(".submit-event").each(function(e,t){var n=(n=eventintegration.apiurl).replace(/\/$/,"");d("#recurring-event",t).children(".box").hide(),this.handleEvents(d(t),n),this.customValidations(t),null!==document.getElementById("location")&&this.loadPostType(d(t),n,"location"),null!==document.getElementById("organizer")&&this.loadPostType(d(t),n,"organizer"),null!==document.getElementById("user_groups")&&this.loadTaxonomy(d(t),n,"user_groups"),null!==document.getElementById("event_categories")&&this.loadTaxonomy(d(t),n,"event_categories")}.bind(this))}function r(e){this.data=e,this.parent=null,this.children=[]}return u.prototype.customValidations=function(n){hyperform.addValidator(n.submitter_repeat_email,function(e){var t=e.value===n.submitter_email.value;return e.setCustomValidity(t?"":eventIntegrationFront.email_not_matching),t})},u.prototype.loadTaxonomy=function(e,t,n){t+="/"+n+"?_jsonp="+n+"&per_page=100";var a=document.getElementById(n);d.ajax({type:"GET",url:t,cache:!1,dataType:"jsonp",jsonpCallback:n,crossDomain:!0,success:function(e){d(a).html("");var t=u.prototype.hierarchicalTax(e);d(t.children).each(function(e,t){u.prototype.addOption(t,a,""),d(t.children).each(function(e,t){u.prototype.addOption(t,a," – "),d(t.children).each(function(e,t){u.prototype.addOption(t,a," – – ")})})})}})},u.prototype.addOption=function(e,t,n){var a=document.createElement("option");a.value=e.data.id,a.innerHTML+=n,a.innerHTML+=e.data.name,t.appendChild(a)},r.comparer=function(e,t){return e.data.name<t.data.name?0:1},r.prototype.sortRecursive=function(){this.children.sort(u.prototype.comparer);for(var e=0,t=this.children.length;e<t;e++)this.children[e].sortRecursive();return this},u.prototype.hierarchicalTax=function(e){var t,n={},a=0,i=e.length;for(n[0]=new r,a=0;a<i;a++)n[e[a].id]=new r(e[a]);for(a=0;a<i;a++)(t=n[e[a].id]).parent=n[t.data.parent],t.parent.children.push(t);return n[0].sortRecursive()},u.prototype.loadPostType=function(e,t,n){t+="/"+n+"/complete?_jsonp=get"+n;var a=document.getElementById(n);d.ajax({type:"GET",url:t,cache:!1,dataType:"jsonp",jsonpCallback:"get"+n,crossDomain:!0,success:function(e){d(a).html("");var t=document.createElement("option");t.value="",t.innerHTML="- Välj -",a.appendChild(t),d(e).each(function(e,t){var n=document.createElement("option");n.value=t.id,n.innerHTML=t.title,a.appendChild(n)})}})},u.prototype.jsonData=function(e){var t=e.serializeArray(),l={},n=[],a=[];return d.each(t,function(e,t){switch(t.name){case"user_groups":n=d.map(t.value.split(","),function(e){return parseInt(e,10)});break;case"event_categories":a.push(parseInt(t.value));break;default:l[t.name]=t.value}}),l.occasions=[],d(".occurance-group-single",e).each(function(e){var t=u.prototype.formatDate(d('[name="start_date"]',this).val(),d('[name="start_time_h"]',this).val(),d('[name="start_time_m"]',this).val()),n=u.prototype.formatDate(d('[name="end_date"]',this).val(),d('[name="end_time_h"]',this).val(),d('[name="end_time_m"]',this).val());t&&n&&l.occasions.push({start_date:t,end_date:n,status:"scheduled",content_mode:"master"})}),l.rcr_rules=[],d(".occurance-group-recurring",e).each(function(e){var t=d('[name="recurring_start_h"]',this).val(),n=d('[name="recurring_start_m"]',this).val(),a=!(!t||!n)&&u.prototype.addZero(t)+":"+u.prototype.addZero(n)+":00",i=d('[name="recurring_end_h"]',this).val(),r=d('[name="recurring_end_m"]',this).val(),o=!(!i||!r)&&u.prototype.addZero(i)+":"+u.prototype.addZero(r)+":00",c=!!u.prototype.isValidDate(d('[name="recurring_start_d"]',this).val())&&d('[name="recurring_start_d"]',this).val(),s=!!u.prototype.isValidDate(d('[name="recurring_end_d"]',this).val())&&d('[name="recurring_end_d"]',this).val();a&&o&&c&&s&&l.rcr_rules.push({rcr_week_day:d('[name="weekday"]',this).val(),rcr_start_time:a,rcr_end_time:o,rcr_start_date:c,rcr_end_date:s})}),d("#organizer",e).val()&&(l.organizers=[{organizer:d(e).find("#organizer").val(),main_organizer:!0}]),l.user_groups=n,l.event_categories=a,l},u.prototype.submitImageAjax=function(e,t){return t.append("action","submit_image"),d.ajax({url:eventintegration.ajaxurl,type:"POST",cache:!1,contentType:!1,processData:!1,data:t,error:function(e,t){console.log(t)}})},u.prototype.submitEventAjax=function(n,e){d.ajax({url:eventintegration.ajaxurl,type:"POST",data:{action:"submit_event",data:e},success:function(e){e.success?(d(".submit-success",n).removeClass("hidden"),d(".submit-success .success",n).empty().append('<i class="fa fa-send"></i>Evenemanget har skickats!</li>'),u.prototype.cleanForm(n)):(console.log(e.data),d(".submit-success",n).addClass("hidden"),d(".submit-error",n).removeClass("hidden"),d(".submit-error .warning",n).empty().append('<i class="fa fa-warning"></i>'+e.data+"</li>"))},error:function(e,t){d(".submit-success",n).addClass("hidden"),d(".submit-error",n).removeClass("hidden"),d(".submit-error .warning",n).empty().append('<i class="fa fa-warning"></i>'+t+"</li>")}})},u.prototype.endHourChange=function(e){var t=e.target.closest(".occurrence");if(t){var n=t.querySelector('input[name="start_date"]').value,a=t.querySelector('input[name="end_date"]').value,i=t.querySelector('input[name="start_time_h"]').value;a<=n?e.target.setAttribute("min",i):e.target.setAttribute("min",0)}},u.prototype.endMinuteChange=function(e){var t=e.target.closest(".occurrence");if(t){var n=t.querySelector('input[name="start_date"]').value,a=t.querySelector('input[name="end_date"]').value,i=t.querySelector('input[name="start_time_h"]').value,r=t.querySelector('input[name="end_time_h"]').value,o=t.querySelector('input[name="start_time_m"]').value;a<=n&&r<=i?60<=(o=parseInt(o)+10)?t.querySelector('input[name="end_time_h"]').setAttribute("min",parseInt(i)+1):e.target.setAttribute("min",o):e.target.setAttribute("min",0)}},u.prototype.initPickerEvent=function(){var e=document.querySelectorAll('input[name="start_date"]');Array.from(e).forEach(function(e){e.onchange=function(e){if(e.target.value){var t=e.target.closest(".occurrence");d(t).find('input[name="end_date"]').datepicker("option","minDate",new Date(e.target.value))}}.bind(this)}.bind(this))},u.prototype.initEndHourEvent=function(){var e=document.querySelectorAll('input[name="end_time_h"]');Array.from(e).forEach(function(e){e.onchange=this.endHourChange}.bind(this))},u.prototype.initEndMinuteEvent=function(){var e=document.querySelectorAll('input[name="end_time_m"]');Array.from(e).forEach(function(e){e.onchange=this.endMinuteChange}.bind(this))},u.prototype.initRecurringEndHourEvent=function(){var e=document.querySelectorAll('input[name="recurring_end_h"]');Array.from(e).forEach(function(e){e.onchange=function(e){var t=e.target.closest(".occurrence");if(t){var n=t.querySelector('input[name="recurring_start_h"]').value;e.target.setAttribute("min",n)}}}.bind(this))},u.prototype.initRecurringEndMinuteEvent=function(){var e=document.querySelectorAll('input[name="recurring_end_m"]');Array.from(e).forEach(function(e){e.onchange=function(e){var t=e.target.closest(".occurrence");if(t){var n=t.querySelector('input[name="recurring_start_h"]').value,a=t.querySelector('input[name="recurring_end_h"]').value,i=t.querySelector('input[name="recurring_start_m"]').value;a<=n?60<=(i=parseInt(i)+10)?t.querySelector('input[name="recurring_end_h"]').setAttribute("min",parseInt(n)+1):e.target.setAttribute("min",i):e.target.setAttribute("min",0)}}}.bind(this))},u.prototype.initDateEvents=function(){this.initPickerEvent(),this.initEndHourEvent(),this.initEndMinuteEvent(),this.initRecurringEndHourEvent(),this.initRecurringEndMinuteEvent()},u.prototype.handleEvents=function(i,e){this.initDateEvents(),d(i).on("submit",function(e){e.preventDefault();var t=i.find("#image-input"),n=this.jsonData(i),a=new FormData;d(".submit-error",i).addClass("hidden"),d(".submit-success",i).removeClass("hidden"),d(".submit-success .success",i).empty().append('<i class="fa fa-send"></i>Skickar...</li>'),t.val()?(a.append("file",t[0].files[0]),d.when(this.submitImageAjax(i,a)).then(function(e,t){e.success?(n.featured_media=e.data,this.submitEventAjax(i,n)):(d(".submit-success",i).addClass("hidden"),d(".submit-error",i).removeClass("hidden"),d(".submit-error .warning",i).empty().append('<i class="fa fa-warning"></i>'+eventIntegrationFront.something_went_wrong+"</li>"))})):this.submitEventAjax(i,n)}.bind(this)),d(".img-button",i).click(function(e){e.preventDefault(),d(".image-box",i).hide(),d(".image-approve",i).fadeIn()}),d("input:radio[name=approve]",i).change(function(){1==this.value?d("#persons-approve",i).removeClass("hidden"):d("#persons-approve",i).addClass("hidden")}),d("input[name=approve]",i).change(function(){var e=0<d("input:checkbox[id=first-approve]:checked",i).length,t=d("input:radio[name=approve]:checked",i).val(),n=0<d("input:checkbox[id=second-approve]:checked",i).length;(e&&0==t||e&&n)&&(d(".image-approve",i).hide(),d(".image-upload",i).fadeIn())}),d("input:radio[name=occurance-type]",i).change(function(e){var t=d(this).data("id");d("#"+t).children(".form-group .box").show().find("input").prop("required",!0),d("#"+t).siblings(".event-occasion").children(".box").hide().find("input").prop("required",!1)}),d(".add-occurance",i).click(function(e){e.preventDefault();var t=d(e.target).parent().prev("[class*=occurance-group]"),n=t.clone().find("input").val("").removeClass("hasDatepicker").removeAttr("id").end().insertAfter(t).find(".datepicker").datepicker().end();if(this.initDateEvents(),0===d(".remove-occurance",n).length){var a=d('<div class="form-group"><button class="btn btn btn-sm remove-occurance"><i class="pricon pricon-minus-o"></i> Ta bort</button></div>');n.append(a)}}.bind(this)),d(document).on("click",".remove-occurance",function(e){e.preventDefault(),d(this).closest("[class*=occurance-group]").remove()})},u.prototype.cleanForm=function(e){d(":input",e).not(":button, :submit, :reset, :hidden, select").val("").removeAttr("selected")},u.prototype.formatDate=function(e,t,n){var a="";return this.isValidDate(e)&&t&&n&&(a=e+"T"+this.addZero(t)+":"+this.addZero(n)+":00"),a},u.prototype.isValidDate=function(e){return null!=e.match(/^\d{4}-\d{2}-\d{2}$/)},u.prototype.addZero=function(e){return 1===e.toString().length&&(e="0"+e),e},new u}(jQuery),(EventManagerIntegration=EventManagerIntegration||{}).Widget=EventManagerIntegration.Widget||{},EventManagerIntegration.Widget.TemplateParser=function(u){var e=new Date,l=e.getDate(),d=e.getMonth()+1,p=e.getFullYear(),m=["jan","feb","mar","apr","maj","jun","jul","aug","sep","okt","nov","dec"];function t(){this.init()}return t.prototype.init=function(){u(".event-api").each(function(e,t){var n=u(t).attr("data-apiurl");n=(n=n.replace(/\/$/,""))+"/event/time?start="+p+"-"+d+"-"+l+"&end="+(p+1)+"-"+d+"-"+l;var a=u(t).attr("post-limit"),i=u(t).attr("group-id"),r=u(t).attr("category-id"),o=u(t).attr("latlng"),c=u(t).attr("distance"),s=void 0!==a&&u.isNumeric(a)?n+"&post-limit="+a:n+"&post-limit=10";s+=void 0!==i&&i?"&group-id="+i:"",s+=void 0!==r&&r?"&category-id="+r:"",s+=void 0!==o&&o?"&latlng="+o:"",s+=void 0!==c&&c?"&distance="+c:"",s+="&_jsonp=getevents",this.storeErrorTemplate(u(t)),this.storeTemplate(u(t)),this.storeModalTemplate(u(t)),this.loadEvent(u(t),s)}.bind(this))},t.prototype.storeTemplate=function(e){e.data("template",u(".template",e).html()),e.find(".template").remove()},t.prototype.storeErrorTemplate=function(e){e.data("error-template",u(".error-template",e).html()),e.find(".error-template").remove()},t.prototype.storeModalTemplate=function(e){e.data("modal-template",u(".modal-template",e).html()),e.find(".modal-template").remove()},t.prototype.loadEvent=function(r,e){u.ajax({type:"GET",url:e,cache:!1,dataType:"jsonp",jsonpCallback:"getevents",crossDomain:!0,success:function(e){r.data("json-response",e),t.prototype.clear(r),u(e).each(function(e,t){var n="";u.each(t.occasions,function(e,t){if(void 0!==t.current_occasion&&1==t.current_occasion)return n=t,!1});var a=new Date(n.start_date),i=r.data("template");i=(i=(i=i.replace("{event-id}",t.id)).replace("{event-occasion}",a.getDate()+'<div class="clearfix"></div>'+m[a.getMonth()])).replace("{event-title}",'<p class="link-item">'+t.title.rendered+"</p>"),r.append(i)}),t.prototype.click(r)},error:function(e){t.prototype.clear(r),r.html(r.data("error-template"))}})},t.prototype.clear=function(e){jQuery(e).html("")},t.prototype.addZero=function(e){return e<10&&(e="0"+e),e},t.prototype.click=function(d){jQuery("li a",d).on("click",{},function(e){var l=jQuery(e.target).closest("a.modal-event").data("event-id");u.each(d.data("json-response"),function(e,t){if(t.id==l){var n=d.data("modal-template");n=(n=(n=(n=n.replace("{event-modal-title}",t.title.rendered)).replace("{event-modal-content}",null!=t.content.rendered?t.content.rendered:"")).replace("{event-modal-link}",null!=t.event_link?'<p><a href="'+t.event_link+'" target="_blank">'+t.event_link+"</a></p>":"")).replace("{event-modal-image}",null!=t.featured_media?"<img src="+t.featured_media.source_url+' alt="'+t.title.rendered+'" style="display:block; width:100%;">':"");var o="";u.each(t.occasions,function(e,t){var n=new Date(t.start_date),a=this.addZero(n.getDate())+" "+m[n.getMonth()]+" "+n.getFullYear()+" kl. "+this.addZero(n.getHours())+":"+this.addZero(n.getMinutes()),i=new Date(t.end_date),r="";r=i.getDate()===n.getDate()?"kl. "+this.addZero(i.getHours())+":"+this.addZero(i.getMinutes()):i.getDate()+" "+m[i.getMonth()]+" "+i.getFullYear()+" kl. "+this.addZero(i.getHours())+":"+this.addZero(i.getMinutes()),o=o+'<li class="text-sm gutter-sm gutter-vertical">'+a+" - "+r+"</li>"}.bind(this)),n=n.replace("{event-modal-occations}",'<section class="accordion-section"><input type="radio" name="active-section" id="accordion-section-1"><label class="accordion-toggle" for="accordion-section-1"><h2>Evenemanget inträffar</h2></label><div class="accordion-content"><ul id="modal-occations">'+o+"</ul></div></section>");var a="";a+=null!=t.location&&null!=t.location.title?"<li><strong>"+t.location.title+"</strong></li>":"",a+=null!=t.location&&null!=t.location.street_address?"<li>"+t.location.street_address+"</li>":"",a+=null!=t.location&&null!=t.location.postal_code?"<li>"+t.location.postal_code+"</li>":"";var i=(a+=null!=t.location&&null!=t.location.city?"<il>"+t.location.city+"</li>":"")?'<section class="accordion-section"><input type="radio" name="active-section" id="accordion-section-2"><label class="accordion-toggle" for="accordion-section-2"><h2>Plats</h2></label><div class="accordion-content"><ul>'+a+"</ul></div></section>":"";n=n.replace("{event-modal-location}",i);var r="";r+=null!=t.booking_phone?"<li>Telefon: "+t.booking_phone+"</li>":"",r+=null!=t.price_adult?"<li>Pris: "+t.price_adult+" kr</li>":"",r+=null!=t.price_children?"<li>Barnpris: "+t.price_children+" kr</li>":"",r+=null!=t.price_senior?"<li>Pensionärspris: "+t.price_senior+" kr</li>":"",r+=null!=t.price_student?"<li>Studentpris: "+t.price_student+" kr</li>":"",r+=null!=t.age_restriction?"<li>Åldersgräns: "+t.age_restriction+" kr</li>":"";var c="";u.each(t.membership_cards,function(e,t){c=c+"<li>"+t.post_title+"</li>"}.bind(this)),r+=c?"<li>&nbsp;</li><li><strong>Ingår i medlemskort</strong></li>"+c:"";var s=(r+=null!=t.booking_link?'<li>&nbsp;</li><li><a href="'+t.booking_link+'" class="link-item" target="_blank">Boka bljetter här</a></li>':"")?'<section class="accordion-section"><input type="radio" name="active-section" id="accordion-section-3"><label class="accordion-toggle" for="accordion-section-3"><h2>Bokning</h2></label><div class="accordion-content"><ul>'+r+"</ul></div></section>":"";n=n.replace("{event-modal-booking}",s),u("#modal-event").remove(),u("body").append(n)}}.bind(this))}.bind(this))},new t}(jQuery);