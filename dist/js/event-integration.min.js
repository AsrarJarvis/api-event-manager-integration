var EventManagerIntegration={};EventManagerIntegration=EventManagerIntegration||{},EventManagerIntegration.Event=EventManagerIntegration.Event||{},EventManagerIntegration.Event.Module=function(e){function t(){e(function(){this.initEventPagination()}.bind(this))}return t.prototype.initEventPagination=function(){e(".modularity-mod-event").each(function(n,a){var o=e(this).find("[module-id]").attr("module-id"),r=e(this).find(".module-pagination").attr("data-pages"),i=e(this);e(this).find(".module-pagination").pagination({pages:r,displayedPages:3,edges:1,cssStyle:"light-theme",ellipsePageSet:!1,prevText:"&laquo;",nextText:"&raquo;",currentPage:1,selectOnClick:!1,onPageClick:function(n,a){t.prototype.loadEvents(n,o,i),e(i).find(".module-pagination").pagination("redraw")}})})},t.prototype.loadEvents=function(t,n,a){var o=e(a).find(".module-content").height();e.ajax({url:eventintegration.ajaxurl,type:"post",data:{action:"ajax_pagination",page:t,id:n},beforeSend:function(){e(a).find(".event-module-list").remove(),e(a).find(".module-content").append('<li class="event-loader"><i class="loading-dots"></i></li>'),e(a).find(".event-loader").height(o),e("html, body").animate({scrollTop:e(a).offset().top},100)},success:function(t){e(a).find(".module-content").append(t).hide().fadeIn(80).height("auto")},error:function(){e(a).find(".module-content").append('<ul class="event-module-list"><li><p>'+eventIntegrationFront.event_pagination_error+"</p></li></ul>").hide().fadeIn(80).height("auto")},complete:function(){e(a).find(".event-loader").remove()}})},new t}(jQuery),EventManagerIntegration=EventManagerIntegration||{},EventManagerIntegration.Event=EventManagerIntegration.Event||{},EventManagerIntegration.Event.Form=function(e){function t(){e(".submit-event").each(function(t,n){e(n).find("#end_date").datepicker(),e(n).find("#start_date").datepicker(),e("#recurring-event",n).children(".box").hide(),this.handleEvents(e(n)),this.loadLocations(e(n),a),this.loadTaxonomy(e(n),a,"user_groups"),this.loadTaxonomy(e(n),a,"event_categories")}.bind(this))}function n(e){this.data=e,this.parent=null,this.children=[]}var a="http://eventmanager.dev/json/wp/v2",o={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t,n,a,r,i,l,d,c="",s=0;for(e=o._utf8_encode(e);s<e.length;)t=e.charCodeAt(s++),n=e.charCodeAt(s++),a=e.charCodeAt(s++),r=t>>2,i=(3&t)<<4|n>>4,l=(15&n)<<2|a>>6,d=63&a,isNaN(n)?l=d=64:isNaN(a)&&(d=64),c=c+this._keyStr.charAt(r)+this._keyStr.charAt(i)+this._keyStr.charAt(l)+this._keyStr.charAt(d);return c},decode:function(e){var t,n,a,r,i,l,d,c="",s=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");s<e.length;)r=this._keyStr.indexOf(e.charAt(s++)),i=this._keyStr.indexOf(e.charAt(s++)),l=this._keyStr.indexOf(e.charAt(s++)),d=this._keyStr.indexOf(e.charAt(s++)),t=r<<2|i>>4,n=(15&i)<<4|l>>2,a=(3&l)<<6|d,c+=String.fromCharCode(t),64!=l&&(c+=String.fromCharCode(n)),64!=d&&(c+=String.fromCharCode(a));return c=o._utf8_decode(c)},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");for(var t="",n=0;n<e.length;n++){var a=e.charCodeAt(n);a<128?t+=String.fromCharCode(a):a>127&&a<2048?(t+=String.fromCharCode(a>>6|192),t+=String.fromCharCode(63&a|128)):(t+=String.fromCharCode(a>>12|224),t+=String.fromCharCode(a>>6&63|128),t+=String.fromCharCode(63&a|128))}return t},_utf8_decode:function(e){for(var t="",n=0,a=c1=c2=0;n<e.length;)a=e.charCodeAt(n),a<128?(t+=String.fromCharCode(a),n++):a>191&&a<224?(c2=e.charCodeAt(n+1),t+=String.fromCharCode((31&a)<<6|63&c2),n+=2):(c2=e.charCodeAt(n+1),c3=e.charCodeAt(n+2),t+=String.fromCharCode((15&a)<<12|(63&c2)<<6|63&c3),n+=3);return t}};return t.prototype.loadTaxonomy=function(n,a,o){a+="/"+o+"?_jsonp="+o+"&per_page=100";var r=document.getElementById(o);e.ajax({type:"GET",url:a,cache:!1,dataType:"jsonp",jsonpCallback:o,crossDomain:!0,success:function(n){if(e(r).html(""),"event_categories"===o){var a=t.prototype.hierarchicalTax(n);e(a.children).each(function(t,n){var a=document.createElement("option");a.value=n.data.id,a.innerHTML=n.data.name,r.appendChild(a),e(n.children).each(function(e,t){var n=document.createElement("option");n.value=t.data.id,n.innerHTML+="undefined"!=typeof t.parent&&0!=t.parent?" – ":"",n.innerHTML+=t.data.name,r.appendChild(n)})})}else e(n).each(function(e,t){var n=document.createElement("option");n.value=t.id,n.innerHTML=t.name,r.appendChild(n)})}})},n.comparer=function(e,t){return e.data.name<t.data.name?0:1},n.prototype.sortRecursive=function(){this.children.sort(t.prototype.comparer);for(var e=0,n=this.children.length;e<n;e++)this.children[e].sortRecursive();return this},t.prototype.hierarchicalTax=function(e){var t,a={},o=0,r=e.length;for(a[0]=new n,o=0;o<r;o++)a[e[o].id]=new n(e[o]);for(o=0;o<r;o++)t=a[e[o].id],t.parent=a[t.data.parent],t.parent.children.push(t);return a[0].sortRecursive()},t.prototype.loadLocations=function(t,n){n+="/location/complete?_jsonp=getlocations";var a=document.getElementById("location");e.ajax({type:"GET",url:n,cache:!1,dataType:"jsonp",jsonpCallback:"getlocations",crossDomain:!0,success:function(t){e(a).html("");var n=document.createElement("option");n.value="",n.innerHTML="Välj plats",a.appendChild(n),e(t).each(function(e,t){var n=document.createElement("option");n.value=t.id,n.innerHTML=t.title,a.appendChild(n)})}})},t.prototype.jsonData=function(t){var n=t.serializeArray(),a={},o=[],r=[];e.each(n,function(e,t){switch(t.name){case"user_groups":o.push(parseInt(t.value));break;case"event_categories":r.push(parseInt(t.value));break;default:a[t.name]=t.value}});var i=this.formatDate(e(t).find("#start_date").val(),e(t).find("#start_time_h").val(),e(t).find("#start_time_m").val()),l=this.formatDate(e(t).find("#end_date").val(),e(t).find("#end_time_h").val(),e(t).find("#end_time_m").val());i&&l&&(a.occasions=[{start_date:i,end_date:l,status:"scheduled",content_mode:"master"}]);var d=e(t).find("#recurring_start_h").val(),c=e(t).find("#recurring_start_m").val(),s=!(!d||!c)&&this.addZero(d)+":"+this.addZero(c)+":00",u=e(t).find("#recurring_end_h").val(),p=e(t).find("#recurring_end_m").val(),h=!(!u||!p)&&this.addZero(u)+":"+this.addZero(p)+":00",g=!!this.isValidDate(e(t).find("#recurring_start_d").val())&&e(t).find("#recurring_start_d").val(),f=!!this.isValidDate(e(t).find("#recurring_end_d").val())&&e(t).find("#recurring_end_d").val();return s&&h&&g&&f&&(a.rcr_rules=[{rcr_week_day:e(t).find("#weekday").val(),rcr_start_time:s,rcr_end_time:h,rcr_start_date:g,rcr_end_date:f}]),e(t).find("#organizer").val()&&(a.organizers=[{organizer:e(t).find("#organizer").val(),main_organizer:!0}]),a.import_client="integration plugin",a.user_groups=o,a.event_categories=r,console.log(a),console.log(JSON.stringify(a)),a},t.prototype.uploadImageAjax=function(t,n){return e.ajax({url:a+"/media",method:"POST",data:n,crossDomain:!0,contentType:!1,processData:!1,beforeSend:function(e){e.setRequestHeader("Authorization","Basic "+o.encode("external-form:test"))},success:function(n){console.log("Image uploaded:"),console.log(n),e(".upload-error",t).addClass("hidden")},error:function(e){console.log(e)}})},t.prototype.submitEventAjax=function(n,r){return e.ajax({url:a+"/event",method:"POST",data:r,crossDomain:!0,contentType:"application/json",beforeSend:function(e){e.setRequestHeader("Authorization","Basic "+o.encode("external-form:test"))},success:function(a){console.log("Event saved:"),console.log(a),t.prototype.cleanForm(n),e(":submit",n).fadeOut(function(){e(this).val("Skickat!").fadeIn()})},error:function(e){console.log(e)}})},t.prototype.handleEvents=function(n){e(n).on("submit",function(a){a.preventDefault();var o=n.find("#image-input"),r=t.prototype.jsonData(n),i=new FormData;o.val()?(i.append("file",o[0].files[0]),e.when(t.prototype.uploadImageAjax(n,i)).fail(function(){e(".upload-error",n).removeClass("hidden")}).then(function(e,a,o){console.log(o.status),console.log(e.id),r.featured_media=e.id,t.prototype.submitEventAjax(n,JSON.stringify(r))})):(e(".upload-error",n).addClass("hidden"),t.prototype.submitEventAjax(n,JSON.stringify(r)))}),e(":radio",n).change(function(t){var n=e(this).data("id");e("#"+n).children(".form-group .box").show(),e("#"+n).siblings(".event-occasion").children(".box").hide()})},t.prototype.cleanForm=function(t){e(":input",t).not(":button, :submit, :reset, :hidden, select").val("").removeAttr("selected")},t.prototype.formatDate=function(e,t,n){var a="";return this.isValidDate(e)&&t&&n&&(a=e+"T"+this.addZero(t)+":"+this.addZero(n)+":00"),a},t.prototype.isValidDate=function(e){var t=/^\d{4}-\d{2}-\d{2}$/;return null!=e.match(t)},t.prototype.addZero=function(e){return 1===e.toString().length&&(e="0"+e),e},new t}(jQuery),EventManagerIntegration=EventManagerIntegration||{},EventManagerIntegration.Widget=EventManagerIntegration.Widget||{},EventManagerIntegration.Widget.TemplateParser=function(e){function t(){this.init()}var n=new Date,a=n.getDate(),o=n.getMonth()+1,r=n.getFullYear(),i=["jan","feb","mar","apr","maj","jun","jul","aug","sep","okt","nov","dec"];return t.prototype.init=function(){e(".event-api").each(function(t,n){var i=e(n).attr("data-apiurl");i=i.replace(/\/$/,""),i=i+"/event/time?start="+r+"-"+o+"-"+a+"&end="+(r+1)+"-"+o+"-"+a;var l=e(n).attr("post-limit"),d=e(n).attr("group-id"),c=e(n).attr("category-id"),s="undefined"!=typeof l&&e.isNumeric(l)?i+"&post-limit="+l:i+"&post-limit=10";s+="undefined"!=typeof d&&d?"&group-id="+d:"",s+="undefined"!=typeof c&&c?"&category-id="+c:"",s+="&_jsonp=getevents",this.storeErrorTemplate(e(n)),this.storeTemplate(e(n)),this.storeModalTemplate(e(n)),this.loadEvent(e(n),s)}.bind(this))},t.prototype.storeTemplate=function(t){t.data("template",e(".template",t).html()),t.find(".template").remove()},t.prototype.storeErrorTemplate=function(t){t.data("error-template",e(".error-template",t).html()),t.find(".error-template").remove()},t.prototype.storeModalTemplate=function(t){t.data("modal-template",e(".modal-template",t).html()),t.find(".modal-template").remove()},t.prototype.loadEvent=function(n,a){e.ajax({type:"GET",url:a,cache:!1,dataType:"jsonp",jsonpCallback:"getevents",crossDomain:!0,success:function(a){n.data("json-response",a),t.prototype.clear(n),e(a).each(function(t,a){var o="";e.each(a.occasions,function(e,t){if("undefined"!=typeof t.current_occasion&&1==t.current_occasion)return o=t,!1});var r=new Date(o.start_date),l=n.data("template");l=l.replace("{event-id}",a.id),l=l.replace("{event-occasion}",r.getDate()+'<div class="clearfix"></div>'+i[r.getMonth()]),l=l.replace("{event-title}",'<p class="link-item">'+a.title.rendered+"</p>"),n.append(l)}),t.prototype.click(n)},error:function(e){t.prototype.clear(n),n.html(n.data("error-template"))}})},t.prototype.clear=function(e){jQuery(e).html("")},t.prototype.addZero=function(e){return e<10&&(e="0"+e),e},t.prototype.click=function(t){jQuery("li a",t).on("click",{},function(n){var a=jQuery(n.target).closest("a.modal-event").data("event-id");e.each(t.data("json-response"),function(n,o){if(o.id==a){var r=t.data("modal-template");r=r.replace("{event-modal-title}",o.title.rendered),r=r.replace("{event-modal-content}",null!=o.content.rendered?o.content.rendered:""),r=r.replace("{event-modal-link}",null!=o.event_link?'<p><a href="'+o.event_link+'" target="_blank">'+o.event_link+"</a></p>":""),r=r.replace("{event-modal-image}",null!=o.featured_media?"<img src="+o.featured_media.source_url+' alt="'+o.title.rendered+'" style="display:block; width:100%;">':"");var l="";e.each(o.occasions,function(e,t){var n=new Date(t.start_date),a=this.addZero(n.getDate())+" "+i[n.getMonth()]+" "+n.getFullYear()+" kl. "+this.addZero(n.getHours())+":"+this.addZero(n.getMinutes()),o=new Date(t.end_date),r="";r=o.getDate()===n.getDate()?"kl. "+this.addZero(o.getHours())+":"+this.addZero(o.getMinutes()):o.getDate()+" "+i[o.getMonth()]+" "+o.getFullYear()+" kl. "+this.addZero(o.getHours())+":"+this.addZero(o.getMinutes()),l=l+'<li class="text-sm gutter-sm gutter-vertical">'+a+" - "+r+"</li>"}.bind(this)),r=r.replace("{event-modal-occations}",'<section class="accordion-section"><input type="radio" name="active-section" id="accordion-section-1"><label class="accordion-toggle" for="accordion-section-1"><h2>Evenemanget inträffar</h2></label><div class="accordion-content"><ul id="modal-occations">'+l+"</ul></div></section>");var d="";d+=null!=o.location&&null!=o.location.title?"<li><strong>"+o.location.title+"</strong></li>":"",d+=null!=o.location&&null!=o.location.street_address?"<li>"+o.location.street_address+"</li>":"",d+=null!=o.location&&null!=o.location.postal_code?"<li>"+o.location.postal_code+"</li>":"",d+=null!=o.location&&null!=o.location.city?"<il>"+o.location.city+"</li>":"";var c=d?'<section class="accordion-section"><input type="radio" name="active-section" id="accordion-section-2"><label class="accordion-toggle" for="accordion-section-2"><h2>Plats</h2></label><div class="accordion-content"><ul>'+d+"</ul></div></section>":"";r=r.replace("{event-modal-location}",c);var s="";s+=null!=o.booking_phone?"<li>Telefon: "+o.booking_phone+"</li>":"",s+=null!=o.price_adult?"<li>Pris: "+o.price_adult+" kr</li>":"",s+=null!=o.price_children?"<li>Barnpris: "+o.price_children+" kr</li>":"",s+=null!=o.price_senior?"<li>Pensionärspris: "+o.price_senior+" kr</li>":"",s+=null!=o.price_student?"<li>Studentpris: "+o.price_student+" kr</li>":"",s+=null!=o.age_restriction?"<li>Åldersgräns: "+o.age_restriction+" kr</li>":"";var u="";e.each(o.membership_cards,function(e,t){u=u+"<li>"+t.post_title+"</li>"}.bind(this)),s+=u?"<li>&nbsp;</li><li><strong>Ingår i medlemskort</strong></li>"+u:"",s+=null!=o.booking_link?'<li>&nbsp;</li><li><a href="'+o.booking_link+'" class="link-item" target="_blank">Boka bljetter här</a></li>':"";var p=s?'<section class="accordion-section"><input type="radio" name="active-section" id="accordion-section-3"><label class="accordion-toggle" for="accordion-section-3"><h2>Bokning</h2></label><div class="accordion-content"><ul>'+s+"</ul></div></section>":"";r=r.replace("{event-modal-booking}",p),e("#modal-event").remove(),e("body").append(r)}}.bind(this))}.bind(this))},new t}(jQuery);